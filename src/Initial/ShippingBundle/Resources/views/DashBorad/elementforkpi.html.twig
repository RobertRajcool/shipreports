
{% extends 'base.html.twig' %}
{% block body %}
    {% block javascripts %}
        {% javascripts '@InitialShippingBundle/Resources/public/js/aa_jquery-1.8.0.min.js' %}
        <script src="{{ asset_url }}" xmlns="http://www.w3.org/1999/html"></script>
        {% endjavascripts %}
        {% javascripts '@InitialShippingBundle/Resources/public/js/highchart/highcharts.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        {% javascripts '@InitialShippingBundle/Resources/public/js/highchart/exporting.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        {% javascripts '@InitialShippingBundle/Resources/public/js/highchart/svg.min.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        {% javascripts '@InitialShippingBundle/Resources/public/js/bootstrap.min.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        <script type="text/javascript">
            {{ chart(chart) }}
        </script>
        <script>
            $(document).ready(function()
            {
                $('#row_id').hide();
                $('#commentform').hide();
                $('#addcomment').hide();
                $('#showcommentform').click(function()
                {
                    $('#commentform').show();
                    $('#usermycommentid').focus();

                });


                $('#addcommentid').click(function()
                {

                    var kpiid=$('#kpiidforname').val();
                    var comment=$('#usermycommentid').val();

                    var data = {kpiid :kpiid,comment:comment} ;
                    $.ajaxSetup({
                        global: false,
                        type: "post",
                        url: "/runtimecomment",
                        beforeSend: function () {
                            $(".modal").show();
                        },
                        complete: function () {
                            $(".modal").hide();
                        }
                    });
                    $.ajax({
                        data: data,
                        success: function (data)
                        {
                            var a=data.lastinsertid;
                            $('#lastid').val(a);

                            $('#viewcommentdiv').remove();

                            $.each(data.ElementNameArray, function(i, listelemnt)
                            {

                                $('<p class="dyaminc">'+listelemnt.comment+'</p>').appendTo("#viewcommentdiv");

                            });


                        }
                        ,
                        error: function()
                        {
                            alert('Error While Generating Image as pdf');

                        }
                    });

                });
                $('#chatform').submit(function(e)
                {
                    e.preventDefault();
                    var self = this;
                    var obj = {},chart;
                    chart = $('#area').highcharts();
                    obj.svg = chart.getSVG();
                    obj.type = 'image/png';
                    obj.width = 450;
                    obj.async = true;
                    var data = {svgid :obj.svg,typeid:obj.type,filewidth:obj.width,fileanys:obj.async} ;
                    $.ajaxSetup({
                        global: false,
                        type: "post",
                        url: "/addchart",
                        beforeSend: function () {
                            $(".modal").show();
                        },
                        complete: function () {
                            $(".modal").hide();
                        }
                    });
                    $.ajax({
                        data: data,
                        success: function (data)
                        {

                            $('#imagefilename').val(data);
                            self.submit();

                        }
                        ,
                        error: function()
                        {
                            alert('Error While Generating Image as pdf');

                        }
                    });

                });

                /*Displaying the rules above the graph*/

                $('#show_rule_id').live("click",function(){
                    var rule_value = $('#rule_value').val();
                    var rule_value_array = splitfun(rule_value);
                    var condition_text = "";
                    $('#row_id').show();

                    $.each(rule_value_array,function(i){
                        var rule_obj = JSON.parse(rule_value_array[i]);

                        $.each(rule_obj.conditions.all, function(j)
                        {
                            if(rule_obj.conditions.all[j].operator=='equalTo')
                            {
                                rule_obj.conditions.all[j].operator='=';
                            }
                            else if(rule_obj.conditions.all[j].operator=='notEqualTo')
                            {
                                rule_obj.conditions.all[j].operator='!=';
                            }
                            else if(rule_obj.conditions.all[j].operator=='greaterThan')
                            {
                                rule_obj.conditions.all[j].operator='>';
                            }
                            else if(rule_obj.conditions.all[j].operator=='greaterThanEqual')
                            {
                                rule_obj.conditions.all[j].operator='>=';
                            }
                            else if(rule_obj.conditions.all[j].operator=='lessThan')
                            {
                                rule_obj.conditions.all[j].operator='<';
                            }
                            else if(rule_obj.conditions.all[j].operator=='lessThanEqual')
                            {
                                rule_obj.conditions.all[j].operator='<=';
                            }
                            var condition_text_one =rule_obj.conditions.all[j].operator+rule_obj.conditions.all[j].value;
                            if(j==0)
                            {
                                condition_text = condition_text_one;
                            }
                            if(j>0)
                            {
                                condition_text = condition_text+'   ' + '&&' +'   '+condition_text_one;
                            }
                        });
                        var $tr = $('<tr>').append(
                                $('<td>').text(condition_text),
                                $('<td>').text(rule_obj.actions.value)
                        ).appendTo('#rule-table');
                    });
                });

                function splitfun(data){
                    var result = data.split('*');
                    return result;
                }

            });


        </script>
    {% endblock %}
    <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
        <div class="page-header">
            <h2>ShipName: <span style="color: #000099">{{ shipname }}</span></h2>
            {#   <a href="{{ path('dashboradhome') }}">Back</a>#}


        </div>
        <div class="bs-example">
            <div class="table-responsive">

                <table class="table table-striped" style="" id="readingkpitable">
                    <thead>
                    <tr>

                        <th>Element Naame</th>
                        <th>Weightage</th>
                        {% for monthname in montharray %}
                            <th>{{ monthname }}</th>
                            {#<th></th>#}

                        {% endfor %}

                    </tr>
                    </thead>
                    <tbody>
                    {% set countmonth1= countmonth-1 %}
                    {% set newelementarray = {} %}
                    {% set newcolorarray = {} %}
                    {% set akj=0 %}
                    {% set i=0 %}
                    {% for element in listofelement %}
                        {% set newelementarray = newelementarray|merge({('_'~i):(element.elementName)}) %}

                        <tr>


                            <td><a  style="color: #2b542c"  href="{{ path('listelementforkpi', { 'kpiid': element.id,'kpiname':element.id,'TB_iframe':true}) }}?keepThis=true&TB_iframe=true" class="thickbox" title="{{ element.elementName }}"> {{ element.elementName }}</a></td>
                            <td>{{ elementweightage[i] }}%</td>
                            {% for j in 0..countmonth1 %}
                                {% set newcolorarray = newcolorarray|merge({('_'~akj):(elementcolorarray[j][i])}) %}


                                <td>
                                    {% if elementcolorarray[j][i]=="Green" %}
                                        <div class="green"></div>
                                    {% elseif elementcolorarray[j][i]=="Red" %}
                                        <div class="red"></div>
                                    {% elseif elementcolorarray[j][i]=="Yellow" %}
                                        <div class="yellow"></div>
                                    {% else %}
                                        <div class="nocolor"></div>
                                    {% endif %}
                                </td>

                                {% set akj=akj+1 %}

                            {% endfor %}
                        </tr>
                        {% set i=i+1 %}
                    {% endfor %}
                    </tbody>
                </table>

                <table>
                    <tr>
                        <td>{{ kpiname }}</td>
                        <td>100%</td>
                        {% for kpi_colors in kpi_color %}
                            <td>
                                {% if kpi_colors =="Green" %}
                                    <div class="green"></div>
                                {% elseif kpi_colors =="Red" %}
                                    <div class="red"></div>
                                {% elseif kpi_colors =="Yellow" %}
                                    <div class="yellow"></div>
                                {% else %}
                                    <div class="nocolor"></div>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th>Avg Score</th>
                        <td>100%</td>
                        {% for avg in avgscore %}
                            <td>{{ avg }}</td>
                        {% endfor %}
                    </tr>

                </table>

                {# Rules display starts here #}

                <input type="button" id="show_rule_id" value="show rules">

                <table id="rule-table">
                    <tr id="row_id">
                        <th>Condition</th>
                        <th>Color</th>
                    </tr>
                </table>

                <div id="viewcommentdiv">
                    {% set newcommandarray = {} %}

                    {% set jk=0 %}
                {% for kpi_rules in kpi_rule %}
                    {% set newcommandarray = newcommandarray|merge({('_'~jk):(kpi_rules.rules)}) %}
                    {% set jk=jk+1 %}
                {% endfor %}
                </div>

                <input type="hidden" name="listofcomments" id="rule_value" value="{{ newcommandarray|join('*') }}">
            </div>
        </div>
            <div class="form-group">
                <div id="area" style="min-width: 400px; height: 400px; margin: 35px auto"></div>
            </div>
            <div class="form-group">
                <div id="viewcommentdiv">
                    {% set newcommandarray = {} %}

                    {% set jk=0 %}
                    {% for comobject in commentarray %}
                        {{ comobject.comment }}
                        {% set newcommandarray = newcommandarray|merge({('_'~jk):(comobject.comment)}) %}
                        {% set jk=jk+1 %}
                    {% endfor %}
                </div>



            </div>
            <button id="showcommentform" class="btn btn-info" >Add Comment</button>&nbsp;&nbsp;

            <a data-toggle="modal" data-target="#mailform" class="btn btn-info" >Send Reports</a>
            {# Form For Send Mail Starts Here #}

            <div class="modal fade" id="mailform" style=" margin-left: 339px;margin-top: -20%;width: 46%" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">Send Report</h4>
                        </div>
                        <div class="modal-body">
                            <form id="chatform" class="form-horizontal no-style" action=" {{path('addcomment') }}" method="post">
                                <input type="hidden" name="montharrayinstring" value="{{ montharray|join(', ') }}">
                                <input type="hidden" name="listofcomments" value="{{ newcommandarray|join(', ') }}">
                                <input type="hidden" name="listofelments" value="{{ newelementarray|join(', ') }}">
                                <input type="hidden" name="elementweightage" value="{{ elementweightage|join(', ') }}">
                                <input type="hidden" name="elementcolorarray" value="{{ newcolorarray|join(', ') }}">
                                <input type="hidden" name="avgscore" value="{{ avgscore|join(', ') }}">
                                <input type="hidden" name="countmonth" value="{{ countmonth }}">

                                <input id="imagefilename" type="hidden" name="send_command[filename]" >
                                <input id="lastid" type="hidden" name="send_command[lastid]" >
                                <input id="kpiidforname" type="hidden" name="send_command[kpiid] " value="{{ kpiid }}">


                                <div class="form-group">
                                    <label class="control-label col-xs-2">Add Comment</label>
                                    <div class="col-xs-10">
                                        <input id="checkbox" value="Yes" type="checkbox" name="send_command[addcomment]" >Yes
                                        <input id="checkbox" value="No" type="checkbox" name="send_command[addcomment]" >No

                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-xs-2">To</label>
                                    <div class="col-xs-10"><input id="toemail" type="email" name="send_command[clientemail]" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-xs-2">Mail Box</label>
                                    <div class="col-xs-10">
                                        <textarea id="mycommentid" name="send_command[comment]" required></textarea>
                                    </div>
                                </div>

                                <div id="sendcommentbutton"  class="actions">
                                    <input id="" class="btn btn-primary" type="submit" value="Send Report">

                                </div>
                            </form>
                        </div>
                    </div> <!-- /.modal-content -->
                </div> <!-- /.modal-dialog -->
            </div>
            {# Form For Send Mail Ends  Here #}

            {# Form For Add Comment  Starts Here #}

            <div  id="commentform" >

                <form  class="form-horizontal no-style"  method="post">
                    <input id="imagefilename" type="hidden" name="send_command[filename]" >
                    <input id="kpiidforname" type="hidden" name="send_command[kpiid] " value="{{ kpiid }}">

                    <div class="form-group">

                        <div class="col-xs-10">
                            <textarea id="usermycommentid" placeholder="Enter Comment Here" name="send_command[comment]" required></textarea>
                        </div>
                    </div>

                    {# <div id="sendcommentbutton"  class="actions">#}
                    <input class="btn btn-primary" id="addcommentid" type="submit" value="Save">

                    {# </div>#}
                </form>

            </div>
            {# Form For Add Comment #}
        </div>
    </div>
{% endblock %}