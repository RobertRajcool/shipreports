
{% extends 'base.html.twig' %}
{% block body %}
    {% block javascripts %}

        {% javascripts '@AppBundle/Resources/public/js/AAA.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        {% javascripts '@InitialShippingBundle/Resources/public/js/highchart/highcharts.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        {% javascripts '@InitialShippingBundle/Resources/public/js/highchart/exporting.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        {% javascripts '@InitialShippingBundle/Resources/public/js/highchart/svg.min.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        {% javascripts '@InitialShippingBundle/Resources/public/js/bootstrap.min.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        <script type="text/javascript">
            {{ chart(chart) }}
        </script>
        <script>
            $(document).ready(function()
            {
                var k = 0;
                {% for element in listofelement %}

                    var abcdef='{{ element.elementName }}';

                    $('<div class="rules_valus" id="rules_valus_id'+k+'" >').appendTo('#rulePlaceId');
                    $('<div class="title">'+abcdef+'</div>').appendTo('#rules_valus_id'+k);
                    var rule_value = $('#'+{{ element.id }}).val();

                    if(rule_value.length != 0  )
                    {
                        var rule_value_array = splitfun(rule_value);

                        $.each(rule_value_array,function(i)
                        {
                            var condition_text = "";
                            var rule_obj = JSON.parse(rule_value_array[i]);

                            $.each(rule_obj.conditions.all, function(j)
                            {
                                if(rule_obj.conditions.all[j].operator=='equalTo')
                                {
                                    rule_obj.conditions.all[j].operator='=';
                                }
                                else if(rule_obj.conditions.all[j].operator=='notEqualTo')
                                {
                                    rule_obj.conditions.all[j].operator='!=';
                                }
                                else if(rule_obj.conditions.all[j].operator=='greaterThan')
                                {
                                    rule_obj.conditions.all[j].operator='>';
                                }
                                else if(rule_obj.conditions.all[j].operator=='greaterThanEqual')
                                {
                                    rule_obj.conditions.all[j].operator='>=';
                                }
                                else if(rule_obj.conditions.all[j].operator=='lessThan')
                                {
                                    rule_obj.conditions.all[j].operator='<';
                                }
                                else if(rule_obj.conditions.all[j].operator=='lessThanEqual')
                                {
                                    rule_obj.conditions.all[j].operator='<=';
                                }
                                var condition_text_one =rule_obj.conditions.all[j].operator+rule_obj.conditions.all[j].value;
                                if(j==0)
                                {
                                    condition_text = condition_text_one;
                                }
                                if(j>0)
                                {
                                    condition_text = condition_text+'   ' + '&&' +'   '+condition_text_one;
                                }
                            });
                            $('<div ><span class="span_1">'+condition_text+'</span><span class="span_1">'+rule_obj.actions.value+'</span></div>').appendTo('#rules_valus_id'+k);

                        });
                    }

                    $('</div>');
                    k++;
                {% endfor %}


                $('#rule_row_id').hide();
                $('#commentform').hide();
                $('#addcomment').hide();
                $('#mailform').hide();

                $('#showcommentform').click(function()
                {
                    $('#commentform').show();
                    $('#usermycommentid').focus();

                });
                $('#sendreports').click(function()
                {

                    $('#commentform').hide();
                    $('#mailform').show();



                });
                $('#toemail').keyup(function()
                {

                    var searchstring=$(this).val();
                    var data = {searchstring :searchstring} ;
                    $.ajaxSetup({
                        global: false,
                        type: "post",
                        url: "/dashborad/autocompeltegroup",
                        beforeSend: function () {
                            /* $("#toemail").css("background","#FFF url(LoaderIcon.gif) no-repeat 165px");*/
                        }
                    });
                    $.ajax({
                        data: data,
                        success: function (data)
                        {

                            if($.isArray(data.returnresult))
                            {
                                $.each(data.returnresult, function(i, listelemnt)
                                {
                                    $('#hiddenresult').val(data.returnresult);

                                    $("#livesearch").show();
                                    $("#livesearch").html('<label class="dynamiclabel">' + listelemnt.groupname + '</label><br><label class="dynamiclabel">' + listelemnt.useremailid + '</label>');
                                    $("#livesearch").css("background", "#FFF");

                                });
                            }
                        }
                        ,
                        error: function()
                        {
                            alert('Error While Generating Image as pdf');

                        }
                    });

                });


                $(".dynamiclabel").live("click",function(e)
                {
                    var b=$(this).text();
                    $('#toemail').val(b);
                });

                $(document).live("click", function(e) {
                    var $clicked = $(e.target);
                    if (! $clicked.hasClass("search_keyword")){
                        $("#livesearch").fadeOut();
                    }
                });

                $('#toemail').click(function(){
                    $("#livesearch").fadeIn();
                });

                $('#addcommentid').click(function()
                {

                    var kpiid=$('#kpiidforname').val();
                    var comment=$('#usermycommentid').val();

                    var data = {kpiid :kpiid,comment:comment} ;
                    $.ajaxSetup({
                        global: false,
                        type: "post",
                        url: "/runtimecommentforkpi",
                        beforeSend: function () {
                            $(".modal").show();
                        },
                        complete: function () {
                            $(".modal").hide();
                        }
                    });
                    $.ajax({
                        data: data,
                        success: function (data)
                        {
                            alert('suc');
                            var a=data.lastinsertid;
                            $('#lastid').val(a);

                            $('#viewcommentdiv').remove();

                            $.each(data.ElementNameArray, function(i, listelemnt)
                            {
                                alert(listelemnt.comment)

                                $('<p class="dyaminc">'+listelemnt.comment+'</p>').appendTo("#viewcommentdiv");

                            });
                        }
                        ,
                        error: function()
                        {
                            alert('Error While Generating Image as pdf');

                        }
                    });

                });

                $('#chatform').submit(function(e)
                {
                    e.preventDefault();
                    var self = this;
                    var obj = {},chart;
                    chart = $('#area').highcharts();
                    obj.svg = chart.getSVG();
                    obj.type = 'image/png';
                    obj.width = 450;
                    obj.async = true;
                    var data = {svgid :obj.svg,typeid:obj.type,filewidth:obj.width,fileanys:obj.async} ;
                    $.ajaxSetup({
                        global: false,
                        type: "post",
                        url: "/addchart",
                        beforeSend: function () {
                            $(".modal").show();
                        },
                        complete: function () {
                            $(".modal").hide();
                        }
                    });
                    $.ajax({
                        data: data,
                        success: function (data)
                        {

                            $('#imagefilename').val(data);
                            self.submit();

                        }
                        ,
                        error: function()
                        {
                            alert('Error While Generating Image as pdf');

                        }
                    });

                });

                /*Displaying the rules above the graph*/

                function splitfun(data){
                    var result = data.split('*');
                    return result;
                }

            });

        </script>

    {% endblock %}

    <div class="{#dashboard_screen_views dashboard_right_ship#}">
        <section>
            <div class="col-md-12 users_advanced_list_views_screen">
                <div class="">
                    <table class="table table-striped graph_and_colour_coding_main_title_row">
                        <thead>
                        <tr>
                            <th>{{ kpiname }}</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>Scorecard: Minimum ~ maximum: 0 ~ 3.0</td>
                        </tr>
                        </tbody>
                    </table>
                    <table class="table table-striped-2 graph_and_colour_coding_row">
                        <thead>
                            {% set i1=0 %}
                            <tr>
                                <th class="kpi_name kpi_name_thtd">Element Naame</th>
                                <th class="weightage">Weightage</th>
                                {% for monthname in montharray %}
                                    <th class="month">{{ monthname }}</th>
                                    {% if i1 != 2 %}
                                        <th class="month_difference">&nbsp;</th>
                                    {% endif %}
                                    {% set i1 = i1+1 %}
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% set countmonth1= countmonth-1 %}
                            {% set newelementarray = {} %}
                            {% set newcolorarray = {} %}
                            {% set akj=0 %}
                            {% set i=0 %}
                            {% for element in listofelement %}
                                {% set newelementarray = newelementarray|merge({('_'~i):(element.elementName)}) %}
                                <tr>
                                    <td class="kpi_name_thtd"><a  style="color: #2b542c"  href="{{ path('listelementforkpi', { 'kpiid': element.id,'kpiname':element.id,'TB_iframe':true}) }}?keepThis=true&TB_iframe=true" class="thickbox" title="{{ element.elementName }}"> {{ element.elementName }}</a></td>
                                    <td>{{ elementweightage[i] }}%</td>
                                    {% for j in 0..countmonth1 %}
                                        {% set newcolorarray = newcolorarray|merge({('_'~akj):(elementcolorarray[j][i])}) %}
                                        <td>
                                            {% if elementcolorarray[j][i]=="Green" %}
                                                <img src="/images/01.png" alt="Loader Image"/>
                                            {% elseif elementcolorarray[j][i]=="Red" %}
                                                <img src="/images/03.png" alt="Loader Image"/>
                                            {% elseif elementcolorarray[j][i]=="Yellow" %}
                                                <img src="/images/02.png" alt="Loader Image"/>
                                            {% endif %}
                                        </td>
                                        {% if j != 2 %}
                                            {% set j1=j+1 %}
                                            <td>
                                                {% if elementcolorarray[j][i]=="Green" and elementcolorarray[j1][i]=="Green" %}
                                                    <img src="/images/straight_arrow.png">
                                                {% elseif elementcolorarray[j][i]=="Green" and elementcolorarray[j1][i]=="Red" %}
                                                    <img src="/images/down_arrow.png">
                                                {% elseif elementcolorarray[j][i]=="Green" and elementcolorarray[j1][i]=="Yellow" %}
                                                    <img src="/images/down_arrow.png">
                                                {% elseif elementcolorarray[j][i]=="Red" and elementcolorarray[j1][i]=="Green" %}
                                                    <img src="/images/up_arrow.png">
                                                {% elseif elementcolorarray[j][i]=="Red" and elementcolorarray[j1][i]=="Red" %}
                                                    <img src="/images/straight_arrow.png">
                                                {% elseif elementcolorarray[j][i]=="Red" and elementcolorarray[j1][i]=="Yellow" %}
                                                    <img src="/images/up_arrow.png">
                                                {% elseif elementcolorarray[j][i]=="Yellow" and elementcolorarray[j1][i]=="Green" %}
                                                    <img src="/images/up_arrow.png">
                                                {% elseif elementcolorarray[j][i]=="Yellow" and elementcolorarray[j1][i]=="Red" %}
                                                    <img src="/images/down_arrow.png">
                                                {% elseif elementcolorarray[j][i]=="Yellow" and elementcolorarray[j1][i]=="Yellow" %}
                                                    <img src="/images/straight_arrow.png">
                                                {% endif %}
                                            </td>
                                        {% endif %}
                                        {% set akj=akj+1 %}
                                    {% endfor %}
                                </tr>
                                {% set i=i+1 %}
                            {% endfor %}
                        </tbody>
                    </table>
                    <table class="table table-striped-2 graph_and_colour_coding_row">
                        {% set k=0 %}
                        <tr>
                            <td class="kpi_name kpi_name_thtd">{{ kpiname }}</td>
                            <td class="weightage">100%</td>
                            {% for kpi_colors_first in kpi_color %}
                                {% for kpi_colors in kpi_colors_first %}
                                <td class="month">
                                    {% if kpi_colors_first[k] =="Green" %}
                                        <img src="/images/01.png" alt="Loader Image"/>
                                    {% elseif kpi_colors_first[k] =="Red" %}
                                        <img src="/images/03.png" alt="Loader Image"/>
                                    {% elseif kpi_colors_first[k] =="Yellow" %}
                                        <img src="/images/02.png" alt="Loader Image"/>
                                    {% endif %}
                                </td>
                                {% if k != 2 %}
                                    {% set k1=k+1 %}
                                    <td class="month_difference">
                                        {% if kpi_colors=="Green" and kpi_colors_first[k1]=="Green" %}
                                            <img src="/images/straight_arrow.png">
                                        {% elseif kpi_colors=="Green" and kpi_colors_first[k1]=="Red" %}
                                            <img src="/images/down_arrow.png">
                                        {% elseif kpi_colors=="Green" and kpi_colors_first[k1]=="Yellow" %}
                                            <img src="/images/down_arrow.png">
                                        {% elseif kpi_colors=="Red" and kpi_colors_first[k1]=="Green" %}
                                            <img src="/images/up_arrow.png">
                                        {% elseif kpi_colors=="Red" and kpi_colors_first[k1]=="Red" %}
                                            <img src="/images/straight_arrow.png">
                                        {% elseif kpi_colors=="Red" and kpi_colors_first[k1]=="Yellow" %}
                                            <img src="/images/up_arrow.png">
                                        {% elseif kpi_colors=="Yellow" and kpi_colors_first[k1]=="Green" %}
                                            <img src="/images/up_arrow.png">
                                        {% elseif kpi_colors=="Yellow" and kpi_colors_first[k1]=="Red" %}
                                            <img src="/images/down_arrow.png">
                                        {% elseif kpi_colors=="Yellow" and kpi_colors_first[k1]=="Yellow" %}
                                            <img src="/images/straight_arrow.png">
                                        {% endif %}
                                    </td>
                                {% endif %}
                                    {% set k=k+1 %}
                                {% endfor %}
                            {% endfor %}
                        </tr>
                        {#{% set k1=0 %}
                        <tr>
                            <th class="kpi_name kpi_name_thtd">Avg Score</th>
                            <td class="weightage"> </td>
                            {% for avg in avgscore %}
                                <td class="month">{{ avg }}</td>
                                {% if k1 != 2 %}
                                    <td class="month_difference">
                                    </td>
                                {% endif %}
                                {% set k1=k1+1 %}
                            {% endfor %}
                        </tr>#}
                    </table>

                    <div id="viewcommentdiv">
                        {% set newcommandarray = {} %}
                        {% set jk=0 %}
                        {% set ik=0 %}
                        {% for kpiRules in elementRule %}
                            {% for kpi_rules in kpiRules %}
                                {% set newcommandarray = newcommandarray|merge({('_'~jk):(kpi_rules.rules)}) %}
                                {% set jk=jk+1 %}
                            {% endfor %}
                            {% if elementRule[ik][0].1  != NULL %}
                                <input type="hidden" name="listofcomments" id={{ elementRule[ik][0].1 }} value="{{ newcommandarray|join('*') }}">
                            {% else %}
                                <input type="hidden" name="listofcomments" id="" value="{{ newcommandarray|join('*') }}">
                            {% endif %}

                            {% set ik=ik+1 %}
                            {% set newcommandarray = {} %}
                        {% endfor %}
                    </div>

                    <div class="rules_ranking"><a ng-click="myFuncKpiRulesShow()" class="rules_show_btn" href="">Rules show</a></div>
                    <table class="table table-striped-4 kpi_ranking_rules_show_row" ng-show="KpiRulesShow">
                        <thead>
                        <tr>
                            <th colspan="3">Rules</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td id="rulePlaceId" class="rulePlace">

                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <table class="table table-striped normal_table">
                        <thead>
                        <tr>
                            <th>Graph Title</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td id="area"></td>
                        </tr>
                        </tbody>
                    </table>

                    <div class="form-group">
                        <div id="viewcommentdiv">
                            {% set newcommandarray = {} %}
                            {% set jk=0 %}
                            {% for comobject in commentarray %}
                                {{ comobject.comment }}
                                {% set newcommandarray = newcommandarray|merge({('_'~jk):(comobject.comment)}) %}
                                {% set jk=jk+1 %}
                            {% endfor %}
                        </div>
                    </div>
                    <button id="showcommentform" class="btn btn-info" >Add Comment</button>&nbsp;&nbsp;

                    <button id="sendreports" class="btn btn-info" >Send Reports</button>
                    {# Form For Send Mail Starts Here #}

                    <div id="mailform">

                        <h4 class="modal-title">Send Report</h4>

                        <form id="chatform" class="form-horizontal no-style" action=" {{path('addcomment') }}" method="post">
                            <input type="hidden" name="montharrayinstring" value="{{ montharray|join(', ') }}">
                            <input type="hidden" name="listofcomments" value="{{ newcommandarray|join(', ') }}">
                            <input type="hidden" name="listofelments" value="{{ newelementarray|join(', ') }}">
                            <input type="hidden" name="elementweightage" value="{{ elementweightage|join(', ') }}">
                            <input type="hidden" name="elementcolorarray" value="{{ newcolorarray|join(', ') }}">
                            <input type="hidden" name="avgscore" value="{{ avgscore|join(', ') }}">
                            <input type="hidden" name="countmonth" value="{{ countmonth }}">

                            <input id="imagefilename" type="hidden" name="send_command[filename]" >
                            <input id="lastid" type="hidden" name="send_command[lastid]" >
                            <input id="kpiidforname" type="hidden" name="send_command[kpiid] " value="{{ kpiid }}">

                            <div class="form-group">
                                <label class="control-label col-xs-2">Add Comment</label>
                                <div class="col-xs-10">
                                    <input id="checkbox" value="Yes" type="checkbox" name="send_command[addcomment]" >Yes
                                    <input id="checkbox" value="No"  type="checkbox" name="send_command[addcomment]" >No
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-2">To</label>
                                <div class="col-xs-10">
                                    <input id="toemail" type="text" name="send_command[clientemail]" required>  <input type="hidden" id="hiddenresult" name="myresult">
                                    <div style="padding-left: 18%;padding-top: 4%" id = "livesearch"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-2">Mail Box</label>
                                <div class="col-xs-10">
                                    <textarea id="mycommentid" name="send_command[comment]" required></textarea>
                                </div>
                            </div>
                            <div id="sendcommentbutton"  class="actions">
                                <input id="" class="btn btn-primary" type="submit" value="Send Report">
                            </div>
                        </form>

                    </div>
                    {# Form For Send Mail Ends  Here #}

                    {# Form For Add Comment  Starts Here #}

                    <div  id="commentform" >

                        <form  class="form-horizontal no-style"  method="post">
                            <input id="imagefilename" type="hidden" name="send_command[filename]" >
                            <input id="kpiidforname" type="hidden" name="send_command[kpiid] " value="{{ kpiid }}">

                            <div class="form-group">

                                <div class="col-xs-10">
                                    <textarea id="usermycommentid" placeholder="Enter Comment Here" name="send_command[comment]" required></textarea>
                                </div>
                            </div>

                            {# <div id="sendcommentbutton"  class="actions">#}
                            <input class="btn btn-primary" id="addcommentid" type="submit" value="Save">

                            {# </div>#}
                        </form>

                    </div>

                </div>
            </div>
        </section>
    </div>
{% endblock %}