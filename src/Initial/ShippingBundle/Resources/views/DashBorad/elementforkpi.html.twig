{% extends 'base.html.twig' %}
{% block body %}
    {% block javascripts %}

        {% javascripts '@InitialShippingBundle/Resources/public/js/aa_jquery-1.8.0.min.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        {% javascripts '@InitialShippingBundle/Resources/public/js/highchart/highcharts.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        {% javascripts '@InitialShippingBundle/Resources/public/js/highchart/exporting.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        {% javascripts '@InitialShippingBundle/Resources/public/js/highchart/svg.min.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        {% javascripts '@InitialShippingBundle/Resources/public/js/bootstrap.min.js' %}
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
        <script type="text/javascript">
            {{ chart(chart) }}
        </script>
        <script>
            $(document).ready(function()
            {
                $('#row_id').hide();
                $('#commentform').hide();
                $('#addcomment').hide();
                $('#mailform').hide();
                $('#viewcommentdiv').hide();
                $('#livesearchdiv').hide();
                $('#hidecomment').hide();

                $('#showcommentform').click(function()
                {
                    $('#buttonid').hide();
                    $('#viewcommentdiv').hide();
                    $('#commentform').show();
                    $('#mailform').hide();
                    $('#usermycommentid').focus();

                });
                $('#sendreports').click(function()
                {

                    $('#commentform').hide();
                    $('#mailform').show();
                    $('#viewcommentdiv').hide();



                });
                $('#viewcomment').click(function()
                {
                    $('#mailform').hide();
                    $('#commentform').hide();
                    $('#viewcommentdiv').show();
                    $('#viewcomment').hide();
                    $('#hidecomment').show();

                });
                $('#hidecomment').click(function()
                {
                    $('#mailform').hide();
                    $('#commentform').hide();
                    $('#viewcommentdiv').hide();
                    $('#viewcomment').show();
                    $('#hidecomment').hide();
                    $('#buttonid').show();

                });
                $('#toemail').keyup(function()
                {

                    var searchstring=$(this).val();
                    var data = {searchstring :searchstring} ;
                    $.ajaxSetup({
                        global: false,
                        type: "post",
                        url:Routing.generate('autocompleteformailing'),
                        beforeSend: function () {
                            /* $("#toemail").css("background","#FFF url(LoaderIcon.gif) no-repeat 165px");*/
                        }
                    });
                    $.ajax({
                        data: data,
                        success: function (data)
                        {

                            if($.isArray(data.returnresult))
                            {
                                $.each(data.returnresult, function(i, listelemnt)
                                {

                                    $('#hiddenresult').val(data.returnresult);
                                    $('#livesearchdiv').show();
                                    $("#livesearch").show();
                                    $("#livesearch").html('<li class="dynamiclabel">' + listelemnt.groupname + '</li><li class="dynamiclabel">' + listelemnt.useremailid + '</li>');

                                });

                            }



                        }
                        ,
                        error: function()
                        {
                            alert('Error While Generating Image as pdf');

                        }
                    });

                });


                $(".dynamiclabel").live("click",function(e)
                {
                    var b=$(this).text();
                    $('#toemail').val(b);
                    $('#livesearchdiv').hide();
                });



                $('#addcommentid').click(function()
                {


                    var kpiid=$('#kpiidforname').val();
                    var comment=$('#usermycommentid').val();

                    var data = {kpiid :kpiid,comment:comment} ;
                    $.ajaxSetup({
                        global: false,
                        type: "post",
                        url: Routing.generate('runtimecommentforkpi'),
                        beforeSend: function () {
                            $(".modal").show();
                        },
                        complete: function () {
                            $(".modal").hide();
                        }
                    });
                    $.ajax({
                        data: data,
                        success: function (data)
                        {
                            $('#usermycommentid').val(' ');
                            $('#commentform').hide();
                            var a=data.lastinsertid;
                            $('#lastid').val(a);
                            $('#viewcommentdiv').text('');
                            if($.isArray(data.resultarray))
                            {
                                // alert('if');
                                $.each(data.resultarray, function(i, listelemnt)
                                {

                                    $('<span>'+listelemnt.comment+'</span>').appendTo('#viewcommentdiv');



                                });
                            }

                            $('#buttonid').show();
                            alert('Comment Added');
                        }
                        ,
                        error: function(XMLHttpRequest, textStatus, errorThrown)
                        {

                            alert('Error : ' + errorThrown);

                        }
                    });

                });
                $('#chatform').submit(function(e)
                {
                    e.preventDefault();
                    var self = this;
                    var obj = {},chart;
                    chart = $('#area').highcharts();
                    obj.svg = chart.getSVG();
                    obj.type = 'image/png';
                    obj.width = 450;
                    obj.async = true;
                    var data = {svgid :obj.svg,typeid:obj.type,filewidth:obj.width,fileanys:obj.async} ;
                    $.ajaxSetup({
                        global: false,
                        type: "post",
                        url: Routing.generate('addchart'),
                        beforeSend: function () {
                            $(".modal").show();
                        },
                        complete: function () {
                            $(".modal").hide();
                        }
                    });
                    $.ajax({
                        data: data,
                        success: function (data)
                        {

                            $('#imagefilename').val(data);
                            submitchatform();

                        }
                        ,
                        error: function()
                        {
                            alert('Error While Generating Image as pdf');

                        }
                    });

                });
                function submitchatform()
                {

                    var form=$('#chatform');
                    $.ajax({
                        type: "post",
                        data: form.serialize(),
                        url: Routing.generate('addcommentkpi'),
                        success: function (data)
                        {
                            $('#commentform').hide();
                            $('#mailform').hide();
                            $('#addcomment').hide();

                            alert(data.updatemsg);

                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown)
                        {
                            alert('Error : ' + errorThrown);
                        }
                    });
                };


                //var actionColor = "";
                var elements = [];

                var k = 0;
                {% for element in listofelement %}

                elements.push(['{{ element.elementName }}','{{ element.id }}']);
                var abcdef='{{ element.elementName }}';

                $('<div class="rules_valus" id="rules_valus_id'+k+'" >').appendTo('#rulePlaceId');
                $('<div class="title">'+abcdef+'</div>').appendTo('#rules_valus_id'+k);
                var rule_value = $('#'+{{ element.id }}).val();
                var rule_value_array = splitfun(rule_value);

                $.each(rule_value_array,function(i)
                {
                    var condition_text = "";
                    var rule_obj = JSON.parse(rule_value_array[i]);

                    $.each(rule_obj.conditions.all, function(j)
                    {
                        if(rule_obj.conditions.all[j].operator=='equalTo')
                        {
                            rule_obj.conditions.all[j].operator='=';
                        }
                        else if(rule_obj.conditions.all[j].operator=='notEqualTo')
                        {
                            rule_obj.conditions.all[j].operator='!=';
                        }
                        else if(rule_obj.conditions.all[j].operator=='greaterThan')
                        {
                            rule_obj.conditions.all[j].operator='>';
                        }
                        else if(rule_obj.conditions.all[j].operator=='greaterThanEqual')
                        {
                            rule_obj.conditions.all[j].operator='>=';
                        }
                        else if(rule_obj.conditions.all[j].operator=='lessThan')
                        {
                            rule_obj.conditions.all[j].operator='<';
                        }
                        else if(rule_obj.conditions.all[j].operator=='lessThanEqual')
                        {
                            rule_obj.conditions.all[j].operator='<=';
                        }
                        var condition_text_one =rule_obj.conditions.all[j].operator+rule_obj.conditions.all[j].value;
                        if(j==0)
                        {
                            condition_text = condition_text_one;
                        }
                        if(j>0)
                        {
                            condition_text = condition_text+'   ' + '&&' +'   '+condition_text_one;
                        }
                    });
                    $('<div ><span class="span_1">'+condition_text+'</span><span class="span_1">'+rule_obj.actions.value+'</span></div>').appendTo('#rules_valus_id'+k);

                });

                $('</div>');
                k++;
                {% endfor %}

                $('#rule_row_id').hide();
                /*Displaying the rules above the graph*/

                function splitfun(data){
                    var result = data.split('*');
                    return result;
                }

            });

        </script>

    {% endblock %}
    <div class="col-md-12 users_advanced_list_views_screen">

        <div class="table-responsive">
            <table class="table table-striped graph_and_colour_coding_main_title_row">
                <thead>
                <tr>
                    <th>{{ kpiname }}</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>Scorecard: Minimum ~ maximum: 0 ~ 3.0</td>
                </tr>
                </tbody>
            </table>
            <table class="table table-striped-2 graph_and_colour_coding_row">
                <thead>
                {% set i1=0 %}
                <tr>
                    <th class="kpi_name kpi_name_thtd">Element Naame</th>
                    <th class="weightage">Weightage</th>
                    {% for monthname in montharray %}
                        <th class="month">{{ monthname }}</th>
                        {% if i1 != 2 %}
                            <th class="month_difference">&nbsp;</th>
                        {% endif %}
                        {% set i1 = i1+1 %}
                    {% endfor %}
                </tr>
                </thead>
                <tbody>
                {% set countmonth1= countmonth-1 %}
                {% set newelementarray = {} %}
                {% set newcolorarray = {} %}
                {% set akj=0 %}
                {% set i=0 %}
                {% for element in listofelement %}
                    {% set newelementarray = newelementarray|merge({('_'~i):(element.elementName)}) %}
                    <tr>
                        <td class="kpi_name_thtd"><a  style="color: #2b542c"  href="{{ path('listelementforkpi', { 'kpiid': element.id,'kpiname':element.id,'TB_iframe':true}) }}?keepThis=true&TB_iframe=true" class="thickbox" title="{{ element.elementName }}"> {{ element.elementName }}</a></td>
                        <td>{{ elementweightage[i] }}%</td>
                        {% for j in 0..countmonth1 %}
                            {% set newcolorarray = newcolorarray|merge({('_'~akj):(elementcolorarray[j][i])}) %}
                            <td>
                                {% if elementcolorarray[j][i]=="Green" %}
                                    <img src="/images/01.png" alt="Loader Image"/>
                                {% elseif elementcolorarray[j][i]=="Red" %}
                                    <img src="/images/03.png" alt="Loader Image"/>
                                {% elseif elementcolorarray[j][i]=="Yellow" %}
                                    <img src="/images/02.png" alt="Loader Image"/>
                                {% endif %}
                            </td>
                            {% if j != 2 %}
                                {% set j1=j+1 %}
                                <td>
                                    {% if elementcolorarray[j][i]=="Green" and elementcolorarray[j1][i]=="Green" %}
                                        <img src="/images/straight_arrow.png">
                                    {% elseif elementcolorarray[j][i]=="Green" and elementcolorarray[j1][i]=="Red" %}
                                        <img src="/images/down_arrow.png">
                                    {% elseif elementcolorarray[j][i]=="Green" and elementcolorarray[j1][i]=="Yellow" %}
                                        <img src="/images/down_arrow.png">
                                    {% elseif elementcolorarray[j][i]=="Red" and elementcolorarray[j1][i]=="Green" %}
                                        <img src="/images/up_arrow.png">
                                    {% elseif elementcolorarray[j][i]=="Red" and elementcolorarray[j1][i]=="Red" %}
                                        <img src="/images/straight_arrow.png">
                                    {% elseif elementcolorarray[j][i]=="Red" and elementcolorarray[j1][i]=="Yellow" %}
                                        <img src="/images/up_arrow.png">
                                    {% elseif elementcolorarray[j][i]=="Yellow" and elementcolorarray[j1][i]=="Green" %}
                                        <img src="/images/up_arrow.png">
                                    {% elseif elementcolorarray[j][i]=="Yellow" and elementcolorarray[j1][i]=="Red" %}
                                        <img src="/images/down_arrow.png">
                                    {% elseif elementcolorarray[j][i]=="Yellow" and elementcolorarray[j1][i]=="Yellow" %}
                                        <img src="/images/straight_arrow.png">
                                    {% endif %}
                                </td>
                            {% endif %}
                            {% set akj=akj+1 %}
                        {% endfor %}
                    </tr>
                    {% set i=i+1 %}
                {% endfor %}
                </tbody>
            </table>
            <table class="table table-striped-2 graph_and_colour_coding_row">
                {% set k=0 %}
                <tr>
                    <td class="kpi_name kpi_name_thtd">{{ kpiname }}</td>
                    <td class="weightage">100%</td>
                    {% for kpi_colors_first in kpi_color %}
                        {% for kpi_colors in kpi_colors_first %}
                            <td class="month">
                                {% if kpi_colors_first[k] =="Green" %}
                                    <img src="/images/01.png" alt="Loader Image"/>
                                {% elseif kpi_colors_first[k] =="Red" %}
                                    <img src="/images/03.png" alt="Loader Image"/>
                                {% elseif kpi_colors_first[k] =="Yellow" %}
                                    <img src="/images/02.png" alt="Loader Image"/>
                                {% endif %}
                            </td>
                            {% if k != 2 %}
                                {% set k1=k+1 %}
                                <td class="month_difference">
                                    {% if kpi_colors=="Green" and kpi_colors_first[k1]=="Green" %}
                                        <img src="/images/straight_arrow.png">
                                    {% elseif kpi_colors=="Green" and kpi_colors_first[k1]=="Red" %}
                                        <img src="/images/down_arrow.png">
                                    {% elseif kpi_colors=="Green" and kpi_colors_first[k1]=="Yellow" %}
                                        <img src="/images/down_arrow.png">
                                    {% elseif kpi_colors=="Red" and kpi_colors_first[k1]=="Green" %}
                                        <img src="/images/up_arrow.png">
                                    {% elseif kpi_colors=="Red" and kpi_colors_first[k1]=="Red" %}
                                        <img src="/images/straight_arrow.png">
                                    {% elseif kpi_colors=="Red" and kpi_colors_first[k1]=="Yellow" %}
                                        <img src="/images/up_arrow.png">
                                    {% elseif kpi_colors=="Yellow" and kpi_colors_first[k1]=="Green" %}
                                        <img src="/images/up_arrow.png">
                                    {% elseif kpi_colors=="Yellow" and kpi_colors_first[k1]=="Red" %}
                                        <img src="/images/down_arrow.png">
                                    {% elseif kpi_colors=="Yellow" and kpi_colors_first[k1]=="Yellow" %}
                                        <img src="/images/straight_arrow.png">
                                    {% endif %}
                                </td>
                            {% endif %}
                            {% set k=k+1 %}
                        {% endfor %}
                    {% endfor %}
                </tr>
            </table>

            <div >
                {% set newcommandarray = {} %}
                {% set jk=0 %}
                {% set ik=0 %}
                {% for kpiRules in elementRule %}
                    {% for kpi_rules in kpiRules %}
                        {% set newcommandarray = newcommandarray|merge({('_'~jk):(kpi_rules.rules)}) %}
                        {% set jk=jk+1 %}
                    {% endfor %}
                    {% if elementRule[ik] != NULL %}
                        {% if elementRule[ik][0].1  != NULL %}
                            <input type="hidden" name="listofcomments" id={{ elementRule[ik][0].1 }} value="{{ newcommandarray|join('*') }}">
                        {% else %}
                            <input type="hidden" name="listofcomments" id="" value="{{ newcommandarray|join('*') }}">
                        {% endif %}
                    {% endif %}

                    {% set ik=ik+1 %}
                    {% set newcommandarray = {} %}
                {% endfor %}
            </div>

            <div class="rules_ranking"><a ng-click="myFuncKpiRulesShow()" class="rules_show_btn" href="">Rules show</a></div>
            <table class="table table-striped-4 kpi_ranking_rules_show_row" ng-show="KpiRulesShow">
                <thead>
                <tr>
                    <th colspan="3">Rules</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td id="rulePlaceId" class="rulePlace">

                    </td>
                </tr>
                </tbody>
            </table>

            <table class="table table-striped normal_table">
                <thead>
                <tr>
                    <th>Graph Title</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td id="area"></td>
                </tr>
                </tbody>
            </table><table class="table table-striped normal_table">
                <tbody>
                <tr>
                    <td id="viewcommentdiv" >
                        {% if commentarray|length <= 0 %}

                            {{ 'elementranking.nocommands'|trans }}
                        {% endif %}
                        {% if commentarray|length > 0 %}
                            {% for comobject in commentarray %}
                                {{ comobject.comment }}

                            {% endfor %}
                        {% endif %}
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="graph_send_comment">


            <div id="buttonid">
                <button value="Submit" id="showcommentform"  class="submit_btn_add">{{ 'elementranking.addcomment'|trans }}</button>
                <button value="Submit" id="sendreports"  class="submit_btn_add">{{ 'elementranking.sendreport'|trans }}</button>
                <button value="Submit" id="viewcomment"  class="submit_btn_add">{{ 'elementranking.viewcomment'|trans }}</button>
                <button value="Submit" id="hidecomment"  class="submit_btn_add">{{ 'elementranking.hidecomment'|trans }}</button>
            </div>
            <div class="add_new_users_form">
                <!--Form for Add comment Starts Here  -->

                <fieldset id="commentform" class="fieldset_box_2">
                    <legend class="legend_name">{{ 'elementranking.addcomment'|trans }}</legend>
                    <form  class="form-horizontal no-style"  method="post">

                        <input id="kpiidforname" type="hidden" name="send_command[kpiid] " value="{{ kpiid }}">

                        <div class="form-group">
                            <div class="col-xs-12">
                                {#<textarea class="add_comment_textarea" placeholder="Enter comment here..."> </textarea>#}
                                <textarea id="usermycommentid" class="add_comment_textarea" placeholder="Enter Comment Here" name="send_command[comment]" required></textarea>
                            </div>
                        </div>
                        {#  <button value="Save" type="submit" class="submit_btn_save">Save</button>#}
                        <input  class="submit_btn_save" id="addcommentid" type="submit" value="{{ 'elementranking.save'|trans }}">
                    </form>
                </fieldset>
                <!--Form for Add comment Ends Here  -->
                <!--Form for Send Reports Starts Here  -->
                <fieldset id="mailform" class="fieldset_box_2">
                    <legend class="legend_name">{{ 'elementranking.sendreport'|trans }}</legend>
                    <form id="chatform" class="form-horizontal no-style" method="post">

                        <input id="imagefilename" type="hidden" name="send_command[filename]" >
                        <input id="lastid" type="hidden" name="send_command[lastid]" >
                        <input id="kpiidforname" type="hidden" name="send_command[kpiid] " value="{{ kpiid }}">
                        <div class="form-group">
                            <label class="control-label required_field col-xs-3">{{ 'elementranking.addcomment'|trans }}</label>
                            <div class="col-xs-9">
                                {#<div class="add_comment_checkbox">
                                    <label><input type="checkbox" name="send_command[addcomment]" class="inline-checkbox"> Yes</label>
                                </div>
                                <div class="add_comment_checkbox">
                                    <label><input type="checkbox" name="send_command[addcomment]" class="inline-checkbox"> No</label>
                                </div>#}
                                <div class="add_comment_checkbox"><label><input type="checkbox"  name="send_command[addcomment]" class="inline-checkbox" value="Yes"> {{ 'elementranking.yes'|trans }}</label></div>
                                <div class="add_comment_checkbox"><label><input type="checkbox"  name="send_command[addcomment]" class="inline-checkbox" value="No"> {{ 'elementranking.no'|trans }}</label></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label required_field col-xs-3">{{ 'elementranking.to'|trans }}</label>
                            <div class="col-xs-9">
                                {#<input type="text" class="send_reports_to_input" placeholder="">#}
                                <input id="toemail" type="text" class="send_reports_to_input" name="send_command[clientemail]" required>
                                <div id="livesearchdiv"  class="send_reports_to_input_list">
                                    <ul id="livesearch">

                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label required_field col-xs-3">{{ 'elementranking.mailbox'|trans }}</label>
                            <div class="col-xs-9">
                                {# <textarea class="add_comment_textarea" placeholder="Enter comment here"> </textarea>#}
                                <textarea id="mycommentid" name="send_command[comment]" required class="add_comment_textarea" placeholder="Enter comment here"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-xs-3">&nbsp;</label>
                            <div class="col-xs-9">
                                {#<button value="Send reports" type="submit" class="submit_btn_2">Send reports</button>#}
                                <input id="" class="submit_btn_2" type="submit" value="{{ 'elementranking.sendreport'|trans }}">
                            </div>

                        </div>
                    </form>
                </fieldset>
                <!--Form for Send Reports Ends Here  -->

            </div>


        </div>
    </div>
{% endblock %}